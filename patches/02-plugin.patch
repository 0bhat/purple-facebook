diff -r 9e295f087bf6 libpurple/protocols/facebook/facebook.c
--- a/libpurple/protocols/facebook/facebook.c	Wed Jun 24 18:13:18 2015 -0400
+++ b/libpurple/protocols/facebook/facebook.c	Thu Jun 25 08:27:37 2015 -0400
@@ -541,7 +541,8 @@
 }
 
 static gint
-fb_im_send(PurpleConnection *gc, PurpleMessage *msg)
+fb_im_send(PurpleConnection *gc, const gchar *who, const gchar *msg,
+           PurpleMessageFlags flags)
 {
 	const gchar *name;
 	const gchar *text;
@@ -552,10 +553,10 @@
 	fata = purple_connection_get_protocol_data(gc);
 	api = fb_data_get_api(fata);
 
-	name = purple_message_get_recipient(msg);
+	name = who;
 	uid = FB_ID_FROM_STR(name);
 
-	text = purple_message_get_contents(msg);
+	text = msg;
 	fb_api_message(api, uid, FALSE, text);
 	return 1;
 }
@@ -629,7 +630,8 @@
 }
 
 static gint
-fb_chat_send(PurpleConnection *gc, gint id, PurpleMessage *msg)
+fb_chat_send(PurpleConnection *gc, gint id, const gchar *msg,
+             PurpleMessageFlags flags)
 {
 	const gchar *name;
 	const gchar *text;
@@ -647,13 +649,13 @@
 	name = purple_conversation_get_name(PURPLE_CONVERSATION(chat));
 	tid = FB_ID_FROM_STR(name);
 
-	text = purple_message_get_contents(msg);
+	text = msg;
 	fb_api_message(api, tid, TRUE, text);
 
 	name = purple_account_get_username(acct);
 	purple_serv_got_chat_in(gc, id, name,
-				purple_message_get_flags(msg),
-	                        purple_message_get_contents(msg),
+				flags,
+	                        msg,
 	                        time(NULL));
 	return 0;
 }
@@ -733,111 +735,71 @@
 	g_object_unref(list);
 }
 
-static void
-facebook_protocol_init(PurpleProtocol *protocol)
+static gboolean
+plugin_load(PurplePlugin *plugin)
 {
-	protocol->id      = "prpl-facebook";
-	protocol->name    = "Facebook";
-	protocol->options = OPT_PROTO_CHAT_TOPIC;
-}
-
-static void
-facebook_protocol_class_init(PurpleProtocolClass *klass)
-{
-	klass->login        = fb_login;
-	klass->close        = fb_close;
-	klass->status_types = fb_status_types;
-	klass->list_icon    = fb_list_icon;
-}
-
-static void
-facebook_protocol_client_iface_init(PurpleProtocolClientIface *iface)
-{
-	iface->blist_node_menu = fb_client_blist_node_menu;
-}
-
-static void
-facebook_protocol_server_iface_init(PurpleProtocolServerIface *iface)
-{
-
-}
-
-static void
-facebook_protocol_im_iface_init(PurpleProtocolIMIface *iface)
-{
-	iface->send        = fb_im_send;
-	iface->send_typing = fb_im_send_typing;
-}
-
-static void
-facebook_protocol_chat_iface_init(PurpleProtocolChatIface *iface)
-{
-	iface->join      = fb_chat_join;
-	iface->invite    = fb_chat_invite;
-	iface->send      = fb_chat_send;
-	iface->set_topic = fb_chat_set_topic;
-}
-
-static void
-facebook_protocol_privacy_iface_init(PurpleProtocolPrivacyIface *iface)
-{
-
-}
-
-static void
-facebook_protocol_roomlist_iface_init(PurpleProtocolRoomlistIface *iface)
-{
-	iface->get_list = fb_roomlist_get_list;
-	iface->cancel   = fb_roomlist_cancel;
-}
-
-PURPLE_DEFINE_TYPE_EXTENDED(
-	FacebookProtocol, facebook_protocol, PURPLE_TYPE_PROTOCOL, 0,
-
-	PURPLE_IMPLEMENT_INTERFACE_STATIC(PURPLE_TYPE_PROTOCOL_CLIENT_IFACE,
-	                                  facebook_protocol_client_iface_init)
-	PURPLE_IMPLEMENT_INTERFACE_STATIC(PURPLE_TYPE_PROTOCOL_SERVER_IFACE,
-	                                  facebook_protocol_server_iface_init)
-	PURPLE_IMPLEMENT_INTERFACE_STATIC(PURPLE_TYPE_PROTOCOL_IM_IFACE,
-	                                  facebook_protocol_im_iface_init)
-	PURPLE_IMPLEMENT_INTERFACE_STATIC(PURPLE_TYPE_PROTOCOL_CHAT_IFACE,
-	                                  facebook_protocol_chat_iface_init)
-	PURPLE_IMPLEMENT_INTERFACE_STATIC(PURPLE_TYPE_PROTOCOL_PRIVACY_IFACE,
-	                                  facebook_protocol_privacy_iface_init)
-	PURPLE_IMPLEMENT_INTERFACE_STATIC(PURPLE_TYPE_PROTOCOL_ROOMLIST_IFACE,
-	                                  facebook_protocol_roomlist_iface_init)
-);
-
-static PurplePluginInfo *
-plugin_query(GError **error)
-{
-	return purple_plugin_info_new(
-		"id",          "prpl-facebook",
-		"name",        "Facebook Protocol",
-		"version",     DISPLAY_VERSION,
-		"category",    N_("Protocol"),
-		"summary",     N_("Facebook Protocol Plugin"),
-		"description", N_("Facebook Protocol Plugin"),
-		"website",     PURPLE_WEBSITE,
-		"abi-version", PURPLE_ABI_VERSION,
-		"flags",       PURPLE_PLUGIN_INFO_FLAGS_INTERNAL |
-		               PURPLE_PLUGIN_INFO_FLAGS_AUTO_LOAD,
-		NULL
-	);
+	_purple_socket_init();
+	purple_http_init();
+	return TRUE;
 }
 
 static gboolean
-plugin_load(PurplePlugin *plugin, GError **error)
+plugin_unload(PurplePlugin *plugin)
 {
-	facebook_protocol_register_type(plugin);
-	my_protocol = purple_protocols_add(FACEBOOK_TYPE_PROTOCOL, error);
-	return my_protocol != NULL;
+	purple_http_uninit();
+	_purple_socket_uninit();
+	return TRUE;
 }
 
-static gboolean
-plugin_unload(PurplePlugin *plugin, GError **error)
+G_MODULE_EXPORT gboolean
+purple_init_plugin(PurplePlugin *plugin);
+
+G_MODULE_EXPORT gboolean
+purple_init_plugin(PurplePlugin *plugin)
 {
-	return purple_protocols_remove(my_protocol, error);
+	static gboolean inited = FALSE;
+	static PurplePluginInfo info;
+	static PurplePluginProtocolInfo pinfo;
+
+	plugin->info = &info;
+
+	if (G_LIKELY(inited)) {
+		return purple_plugin_register(plugin);
+	}
+
+	memset(&info, 0, sizeof info);
+	memset(&pinfo, 0, sizeof pinfo);
+
+	info.magic         = PURPLE_PLUGIN_MAGIC;
+	info.major_version = PURPLE_MAJOR_VERSION;
+	info.minor_version = PURPLE_MINOR_VERSION;
+	info.type          = PURPLE_PLUGIN_PROTOCOL;
+	info.priority      = PURPLE_PRIORITY_DEFAULT;
+	info.id            = "prpl-facebook";
+	info.name          = "Facebook";
+	info.version       = PACKAGE_VERSION;
+	info.summary       = N_("Facebook Protocol Plugin");
+	info.description   = N_("Facebook Protocol Plugin");
+	info.homepage      = PACKAGE_URL;
+	info.load          = plugin_load;
+	info.unload        = plugin_unload;
+	info.extra_info    = &pinfo;
+
+	pinfo.options           = OPT_PROTO_CHAT_TOPIC;
+	pinfo.list_icon         = fb_list_icon;
+	pinfo.status_types      = fb_status_types;
+	pinfo.blist_node_menu   = fb_client_blist_node_menu;
+	pinfo.login             = fb_login;
+	pinfo.close             = fb_close;
+	pinfo.send_im           = fb_im_send;
+	pinfo.send_typing       = fb_im_send_typing;
+	pinfo.join_chat         = fb_chat_join;
+	pinfo.chat_invite       = fb_chat_invite;
+	pinfo.chat_send         = fb_chat_send;
+	pinfo.set_chat_topic    = fb_chat_set_topic;
+	pinfo.roomlist_get_list = fb_roomlist_get_list;
+	pinfo.roomlist_cancel   = fb_roomlist_cancel;
+
+	inited = TRUE;
+	return purple_plugin_register(plugin);
 }
-
-PURPLE_PLUGIN_INIT(facebook, plugin_query, plugin_load, plugin_unload);
diff -r 9e295f087bf6 libpurple/protocols/facebook/facebook.h
--- a/libpurple/protocols/facebook/facebook.h	Wed Jun 24 18:13:18 2015 -0400
+++ b/libpurple/protocols/facebook/facebook.h	Thu Jun 25 08:27:37 2015 -0400
@@ -25,29 +25,4 @@
 #include "glibcompat.h"
 #include "protocol.h"
 
-#define FACEBOOK_TYPE_PROTOCOL             (facebook_protocol_get_type())
-#define FACEBOOK_PROTOCOL(obj)             (G_TYPE_CHECK_INSTANCE_CAST((obj), FACEBOOK_TYPE_PROTOCOL, FacebookProtocol))
-#define FACEBOOK_PROTOCOL_CLASS(klass)     (G_TYPE_CHECK_CLASS_CAST((klass), FACEBOOK_TYPE_PROTOCOL, FacebookProtocolClass))
-#define FACEBOOK_IS_PROTOCOL(obj)          (G_TYPE_CHECK_INSTANCE_TYPE((obj), FACEBOOK_TYPE_PROTOCOL))
-#define FACEBOOK_IS_PROTOCOL_CLASS(klass)  (G_TYPE_CHECK_CLASS_TYPE((klass), FACEBOOK_TYPE_PROTOCOL))
-#define FACEBOOK_PROTOCOL_GET_CLASS(obj)   (G_TYPE_INSTANCE_GET_CLASS((obj), FACEBOOK_TYPE_PROTOCOL, FacebookProtocolClass))
-
-typedef struct _FacebookProtocol FacebookProtocol;
-typedef struct _FacebookProtocolClass FacebookProtocolClass;
-
-struct _FacebookProtocol
-{
-	PurpleProtocol parent;
-};
-
-struct _FacebookProtocolClass
-{
-	PurpleProtocolClass parent_class;
-};
-
-/**
- * Returns the GType for the FacebookProtocol object.
- */
-G_MODULE_EXPORT GType facebook_protocol_get_type(void);
-
 #endif /* _FACEBOOK_H_ */
